{% extends "base.html" %}

{% block title %}Asset - Gestione Media{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="page-title">
            <h1>
                <i class="icon">üñºÔ∏è</i>
                Asset - Gestione Media
            </h1>
            <p class="subtitle">Gestisci immagini e file multimediali per le tue carte AAC</p>
        </div>
        <div class="page-actions">
            <a href="{{ url_for('assets.upload_asset') }}" class="btn btn-primary">
                <i class="icon">‚¨ÜÔ∏è</i>
                Carica File
            </a>
        </div>
    </div>

    <!-- Statistiche -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.total }}</div>
                <div class="stat-label">Asset Totali</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üñºÔ∏è</div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.images }}</div>
                <div class="stat-label">Immagini</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üíæ</div>
            <div class="stat-content">
                <div class="stat-number">{{ "%.1f"|format(stats.total_size / 1024 / 1024) }} MB</div>
                <div class="stat-label">Spazio Utilizzato</div>
            </div>
        </div>
    </div>

    <!-- Filtri e Ricerca -->
    <div class="filter-section">
        <form method="GET" class="filter-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="search">Cerca Asset</label>
                    <input type="text" 
                           id="search" 
                           name="search" 
                           value="{{ search }}" 
                           placeholder="Nome file, tipo..."
                           class="form-control">
                </div>
                <div class="form-group">
                    <label for="type">Tipo File</label>
                    <select id="type" name="type" class="form-control">
                        <option value="">Tutti i tipi</option>
                        <option value="image" {% if file_type == 'image' %}selected{% endif %}>Immagini</option>
                        <option value="audio" {% if file_type == 'audio' %}selected{% endif %}>Audio</option>
                        <option value="video" {% if file_type == 'video' %}selected{% endif %}>Video</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sort">Ordina per</label>
                    <select id="sort" name="sort" class="form-control">
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Data Creazione</option>
                        <option value="filename" {% if sort_by == 'filename' %}selected{% endif %}>Nome File</option>
                        <option value="size" {% if sort_by == 'size' %}selected{% endif %}>Dimensione</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="order">Ordine</label>
                    <select id="order" name="order" class="form-control">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Decrescente</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Crescente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-secondary">Filtra</button>
                        <a href="{{ url_for('assets.list_assets') }}" class="btn btn-ghost">Reset</a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Lista Asset -->
    {% if assets %}
        <div class="assets-grid">
            {% for asset in assets %}
                <div class="asset-card" data-asset-id="{{ asset.id }}">
                    <div class="asset-preview">
                        {% if asset.mimetype and asset.mimetype.startswith('image/') %}
                            <img src="{{ url_for('static', filename='media/' + asset.filename) }}" 
                                 alt="{{ asset.original_filename }}"
                                 class="asset-image"
                                 loading="lazy">
                        {% else %}
                            <div class="asset-file-icon">
                                {% if asset.mimetype and asset.mimetype.startswith('audio/') %}
                                    üéµ
                                {% elif asset.mimetype and asset.mimetype.startswith('video/') %}
                                    üé¨
                                {% else %}
                                    üìÑ
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <div class="asset-overlay">
                            <div class="asset-actions">
                                <a href="{{ url_for('assets.view_asset', asset_id=asset.id) }}" 
                                   class="btn btn-sm btn-primary" 
                                   title="Visualizza">
                                    üëÅÔ∏è
                                </a>
                                <a href="{{ url_for('assets.edit_asset', asset_id=asset.id) }}" 
                                   class="btn btn-sm btn-secondary" 
                                   title="Modifica">
                                    ‚úèÔ∏è
                                </a>
                                <button type="button" 
                                        class="btn btn-sm btn-danger delete-asset-btn" 
                                        data-asset-id="{{ asset.id }}"
                                        data-asset-name="{{ asset.original_filename }}"
                                        title="Elimina">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="asset-info">
                        <h3 class="asset-title">{{ asset.original_filename }}</h3>
                        <div class="asset-meta">
                            <span class="asset-type">{{ asset.mimetype.split('/')[0] if asset.mimetype else 'unknown' }}</span>
                            <span class="asset-size">{{ "%.1f"|format(asset.file_size / 1024) }} KB</span>
                            {% if asset.width and asset.height %}
                                <span class="asset-dimensions">{{ asset.width }}√ó{{ asset.height }}</span>
                            {% endif %}
                        </div>
                        <div class="asset-date">
                            Caricato il {{ asset.created_at.strftime('%d/%m/%Y alle %H:%M') }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Paginazione -->
        {% if total_assets > per_page %}
            <div class="pagination-container">
                <div class="pagination-info">
                    Mostrando {{ ((page - 1) * per_page + 1) }}-{{ [page * per_page, total_assets]|min }} 
                    di {{ total_assets }} asset
                </div>
                
                <div class="pagination">
                    {% set total_pages = (total_assets / per_page)|round(0, 'ceil')|int %}
                    
                    {% if page > 1 %}
                        <a href="{{ url_for('assets.list_assets', page=page-1, search=search, type=file_type, sort=sort_by, order=sort_order) }}" 
                           class="pagination-btn">‚Äπ Precedente</a>
                    {% endif %}
                    
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                            <span class="pagination-btn current">{{ p }}</span>
                        {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                            <a href="{{ url_for('assets.list_assets', page=p, search=search, type=file_type, sort=sort_by, order=sort_order) }}" 
                               class="pagination-btn">{{ p }}</a>
                        {% elif p == 4 and page > 6 %}
                            <span class="pagination-ellipsis">...</span>
                        {% elif p == total_pages - 3 and page < total_pages - 5 %}
                            <span class="pagination-ellipsis">...</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page < total_pages %}
                        <a href="{{ url_for('assets.list_assets', page=page+1, search=search, type=file_type, sort=sort_by, order=sort_order) }}" 
                           class="pagination-btn">Successiva ‚Ä∫</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìÅ</div>
            <h3>Nessun Asset Trovato</h3>
            {% if search or file_type %}
                <p>Nessun asset corrisponde ai filtri selezionati.</p>
                <a href="{{ url_for('assets.list_assets') }}" class="btn btn-secondary">Mostra Tutti</a>
            {% else %}
                <p>Non hai ancora caricato nessun file multimediale.</p>
                <a href="{{ url_for('assets.upload_asset') }}" class="btn btn-primary">Carica Primo Asset</a>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Modal Conferma Eliminazione -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Conferma Eliminazione</h3>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Sei sicuro di voler eliminare l'asset <strong id="deleteAssetName"></strong>?</p>
            <p class="warning">‚ö†Ô∏è Questa azione √® irreversibile e l'asset non potr√† pi√π essere utilizzato nelle carte.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Annulla</button>
            <form id="deleteForm" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-danger">Elimina Asset</button>
            </form>
        </div>
    </div>
</div>

<style>
.assets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.asset-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
}

.asset-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.asset-preview {
    position: relative;
    width: 100%;
    height: 200px;
    background: var(--color-neutral-100);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.asset-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.asset-file-icon {
    font-size: 4em;
    opacity: 0.6;
}

.asset-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    opacity: 0;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.asset-card:hover .asset-overlay {
    opacity: 1;
}

.asset-actions {
    display: flex;
    gap: 8px;
}

.asset-actions .btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    font-size: 1.1em;
}

.asset-info {
    padding: 16px;
}

.asset-title {
    font-size: 1em;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: var(--color-text);
    word-break: break-all;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.asset-meta {
    display: flex;
    gap: 12px;
    margin-bottom: 8px;
}

.asset-meta span {
    font-size: 0.85em;
    color: var(--color-text-secondary);
    background: var(--color-neutral-100);
    padding: 2px 6px;
    border-radius: 4px;
}

.asset-date {
    font-size: 0.8em;
    color: var(--color-text-muted);
}

.filter-section {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin: 20px 0;
}

.filter-form .form-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 16px;
    align-items: end;
}

.form-actions {
    display: flex;
    gap: 8px;
}

.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 30px 0;
    padding: 20px 0;
    border-top: 1px solid var(--color-border);
}

.pagination {
    display: flex;
    gap: 4px;
}

.pagination-btn {
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    background: white;
    color: var(--color-text);
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.pagination-btn:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

.pagination-btn.current {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

.pagination-ellipsis {
    padding: 8px 4px;
    color: var(--color-text-muted);
}

@media (max-width: 768px) {
    .assets-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
    }
    
    .filter-form .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .form-actions {
        justify-content: stretch;
    }
    
    .form-actions .btn {
        flex: 1;
    }
    
    .pagination-container {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
}
</style>

<script>
function openDeleteModal(assetId, assetName) {
    document.getElementById('deleteAssetName').textContent = assetName;
    document.getElementById('deleteForm').action = `/assets/${assetId}/delete`;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Gestione bottoni eliminazione
    document.querySelectorAll('.delete-asset-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const assetId = this.dataset.assetId;
            const assetName = this.dataset.assetName;
            openDeleteModal(assetId, assetName);
        });
    });
    
    // Chiusura modal
    document.querySelector('.modal-close').addEventListener('click', closeDeleteModal);
    
    // Chiusura modal cliccando fuori
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    
    // Submit automatico filtri al cambio
    const filterInputs = document.querySelectorAll('#search, #type, #sort, #order');
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.id !== 'search') {
                this.form.submit();
            }
        });
    });
    
    // Submit ricerca con Enter
    document.getElementById('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            this.form.submit();
        }
    });
});
</script>
{% endblock %}